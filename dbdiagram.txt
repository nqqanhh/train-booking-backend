
// Project: Train Ticketing (MySQL) – DBML for dbdiagram.io
// Note: Designed for Node.js backend, no OTP login, no seat hold/countdown.

////////////////////////////////////////////////////////
// ENUMS
////////////////////////////////////////////////////////
Enum user_role {
  user
  admin
}

Enum user_status {
  active
  inactive
  banned
}

Enum trip_status {
  scheduled
  closed
  cancelled
  completed
}

Enum seat_class {
  vip
  standard
}

Enum seat_status {
  available
  sold
}

Enum order_status {
  pending
  paid
  cancelled
  refunded
  failed
}

Enum payment_status {
  initiated
  succeeded
  failed
  refunded
}

Enum ticket_status {
  valid
  used
  refunded
}

////////////////////////////////////////////////////////
// TABLES
////////////////////////////////////////////////////////

Table users {
  id              bigint [pk, increment]
  full_name       varchar(255) [not null]
  email           varchar(255) [unique]
  phone           varchar(32)  [unique]
  password_hash   text         [not null]
  role            user_role    [not null, default: 'user']
  status          user_status  [not null, default: 'active']
  created_at      timestamp    [not null, default: `CURRENT_TIMESTAMP`]
  updated_at      timestamp    [not null, default: `CURRENT_TIMESTAMP`, note: 'ON UPDATE CURRENT_TIMESTAMP']

  Note: 'Hồ sơ người dùng; đăng nhập bằng email hoặc SĐT + password'
}

Table passenger_profiles {
  id            bigint [pk, increment]
  user_id       bigint [not null]
  full_name     varchar(255) [not null]
  id_no         varchar(64)
  dob           date
  phone         varchar(32)

  Note: 'Danh bạ hành khách thường xuyên của user (điền nhanh khi đặt vé)'
}

Table routes {
  id              bigint [pk, increment]
  origin          varchar(255) [not null]
  destination     varchar(255) [not null]
  distance_km     decimal(8,2)
  eta_minutes     smallint
  active          boolean [not null, default: true]
  created_at      timestamp [not null, default: `CURRENT_TIMESTAMP`]
  updated_at      timestamp [not null, default: `CURRENT_TIMESTAMP`]

  Note: 'Tuyến tàu: Điểm đi → Điểm đến'
}

Table seat_templates {
  id          bigint [pk, increment]
  name        varchar(255) [not null]
  meta_json   json
  created_at  timestamp [not null, default: `CURRENT_TIMESTAMP`]

  Note: 'Mẫu sơ đồ ghế (layout 2D, tầng/hàng/cột)'
}

Table seat_template_seats {
  id            bigint [pk, increment]
  template_id   bigint  [not null]
  seat_code     varchar(32) [not null]
  seat_class    seat_class  [not null]
  base_price    decimal(12,2) [not null]
  pos_row       int
  pos_col       int

  Indexes {
    (template_id, seat_code) [unique, name: 'uk_tpl_code']
  }

  Note: 'Danh sách ghế thuộc template (để vẽ 2D và nhân bản cho Trip)'
}

Table trips {
  id                 bigint [pk, increment]
  route_id           bigint [not null]
  departure_time     datetime [not null]
  arrival_time       datetime
  vehicle_no         varchar(64)
  status             trip_status [not null, default: 'scheduled']
  seat_template_id   bigint [not null]
  created_at         timestamp [not null, default: `CURRENT_TIMESTAMP`]
  updated_at         timestamp [not null, default: `CURRENT_TIMESTAMP`]

  Indexes {
    (route_id, departure_time) [name: 'idx_trips_route_depart']
  }

  Note: 'Chuyến tàu theo ngày/giờ; sinh ghế từ seat_template'
}

Table trip_seats {
  id          bigint [pk, increment]
  trip_id     bigint [not null]
  seat_code   varchar(32) [not null]
  seat_class  seat_class  [not null]
  price       decimal(12,2) [not null]
  status      seat_status [not null, default: 'available']

  Indexes {
    (trip_id, seat_code) [unique, name: 'uk_trip_seat']
    (trip_id, status)    [name: 'idx_trip_seats_trip_status']
  }

  Note: 'Ghế thực tế của chuyến; chỉ chuyển sold sau khi thanh toán thành công'
}

Table orders {
  id             bigint [pk, increment]
  user_id        bigint [not null]
  status         order_status [not null, default: 'pending']
  total_amount   decimal(12,2) [not null, default: 0]
  coupon_code    varchar(64)
  created_at     timestamp [not null, default: `CURRENT_TIMESTAMP`]
  updated_at     timestamp [not null, default: `CURRENT_TIMESTAMP`]

  Indexes {
    (user_id, created_at) [name: 'idx_orders_user']
  }

  Note: 'Đơn hàng; hỗ trợ one-way & round-trip bằng nhiều OrderItem'
}

Table order_items {
  id               bigint [pk, increment]
  order_id         bigint [not null]
  trip_seat_id     bigint [not null]
  passenger_name   varchar(255) [not null]
  passenger_id_no  varchar(64)
  unit_price       decimal(12,2) [not null]
  discount_amount  decimal(12,2) [not null, default: 0]

  Indexes {
    (order_id, trip_seat_id) [unique, name: 'uk_order_item_seat']
  }

  Note: 'Mỗi ghế là 1 item; 1-1 với ticket sau khi paid'
}

Table payments {
  id               bigint [pk, increment]
  order_id         bigint [not null]
  provider         varchar(64) [not null]          // mock, momo, vnpay...
  provider_txn_id  varchar(128)
  amount           decimal(12,2) [not null]
  status           payment_status [not null]
  raw_payload      json
  created_at       timestamp [not null, default: `CURRENT_TIMESTAMP`]

  Indexes {
    (provider, provider_txn_id) [unique, name: 'uk_provider_txn']
  }

  Note: 'Giao dịch thanh toán; 1-n cho mỗi đơn (retry/cổng khác)'
}

Table tickets {
  id             bigint [pk, increment]
  order_item_id  bigint [not null, unique]
  qr_payload     text   [not null]
  status         ticket_status [not null, default: 'valid']
  issued_at      timestamp [not null, default: `CURRENT_TIMESTAMP`]
  used_at        datetime

  Note: 'Vé điện tử có QR; tạo sau khi order=paid; 1-1 với OrderItem'
}

Table coupons {
  id          bigint [pk, increment]
  code        varchar(64) [not null, unique]
  type        varchar(16) [not null]   // 'percent' | 'fixed'
  value       decimal(12,2) [not null]
  valid_from  datetime
  valid_to    datetime
  quota       int
  active      boolean [not null, default: true]

  Note: 'Mã khuyến mãi (tuỳ chọn)'
}

Table notifications {
  id        bigint [pk, increment]
  user_id   bigint
  type      varchar(32)
  title     varchar(255)
  body      text
  sent_at   datetime

  Indexes {
    (user_id, sent_at) [name: 'idx_noti_user']
  }

  Note: 'Log thông báo đẩy/email'
}

Table support_requests {
  id         bigint [pk, increment]
  user_id    bigint
  subject    varchar(255)
  message    text
  status     varchar(32) [default: 'open']
  created_at timestamp [not null, default: `CURRENT_TIMESTAMP`]
  closed_at  datetime

  Indexes {
    (user_id, created_at) [name: 'idx_sr_user']
  }

  Note: 'Yêu cầu hỗ trợ từ người dùng'
}

////////////////////////////////////////////////////////
// RELATIONSHIPS
////////////////////////////////////////////////////////

Ref: passenger_profiles.user_id > users.id [delete: cascade]

Ref: seat_template_seats.template_id > seat_templates.id [delete: cascade]

Ref: trips.route_id > routes.id
Ref: trips.seat_template_id > seat_templates.id

Ref: trip_seats.trip_id > trips.id [delete: cascade]

Ref: orders.user_id > users.id

Ref: order_items.order_id > orders.id [delete: cascade]
Ref: order_items.trip_seat_id > trip_seats.id

Ref: payments.order_id > orders.id [delete: cascade]

Ref: tickets.order_item_id > order_items.id [delete: cascade]

Ref: notifications.user_id > users.id [delete: cascade]

Ref: support_requests.user_id > users.id [delete: set null]
